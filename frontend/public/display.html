<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Registrar Queue Display</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .wrap{padding:30px;display:flex;gap:24px}
    h1{font-size:44px;margin:0 0 12px 20px}
    .col{background:#0f1a1c;border-radius:10px;padding:12px;width:26%;box-shadow:var(--panel-shadow)}
    .col h3{text-align:center;margin:0 0 8px}
    .panel-called{background: linear-gradient(90deg,#6fb3ff,#ffd25b); color:#03203a; padding:16px; border-radius:8px; margin-bottom:12px}
    .panel-called .token{font-size:56px;font-weight:700}
    .panel-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#071014;border-radius:6px;margin-bottom:8px}
    .panel-row .token-small{width:60px;font-weight:700}
    .no-tokens{color:#98a3a7;padding:18px;text-align:center}
  </style>
</head>
<body>
  <h1 style="padding:18px 30px;margin:0">Registrar Queue Display</h1>
  
  <div class="wrap" id="wrap"></div>

<script>
const API = location.origin.includes('5173') ? 'http://localhost:4000' : (location.protocol + '//' + location.host);

// fetch and render
async function fetchQueue(){
  try {
    const r = await fetch(API + '/queue');
    const data = await r.json();
    render(data || []);
  } catch(e) {
    console.error('fetchQueue', e);
  }
}

function render(tickets){
  const wrap = document.getElementById('wrap');
  wrap.innerHTML = '';
  const services = ['registrar','cashier','admissions','records'];
  services.forEach(svc=>{
    const col = document.createElement('div'); col.className='col';
    const h = document.createElement('h3'); h.textContent = svc.charAt(0).toUpperCase() + svc.slice(1);
    col.appendChild(h);

    // enrich tickets
    const enriched = tickets.map(t => {
      let svs = [];
      try { svs = Array.isArray(t.services) ? t.services : JSON.parse(t.services||'[]'); } catch(e){ svs=[]; }
      const idx = Number(t.service_index||0);
      const current = svs[idx] || null;
      const displayToken = (svc[0]?.toUpperCase() || '') + String(t.id).padStart(3,'0');
      return {...t, servicesArr:svs, current_service: current, displayToken};
    });

    const called = enriched.find(t => t.status === 'called' && t.called_service === svc);
    if (called) {
      const c = document.createElement('div'); c.className='panel-called';
      const tok = document.createElement('div'); tok.className='token'; tok.textContent = called.displayToken;
      const name = document.createElement('div'); name.textContent = called.name || 'No name';
      const meta = document.createElement('div'); meta.style.opacity = 0.9; meta.textContent = (called.quer_type || '') + ' • ' + (called.status || '');
      c.appendChild(tok); c.appendChild(name); c.appendChild(meta);
      col.appendChild(c);
    }

    // waiting list for this service (exclude called)
    const waiting = enriched.filter(t => (t.status === 'waiting' || t.status === 'hold') && t.current_service === svc);
    if (waiting.length === 0) {
      if(!called) {
        const n = document.createElement('div'); n.className='no-tokens'; n.textContent = 'No tokens';
        col.appendChild(n);
      }
    } else {
      waiting.forEach(w=>{
        // small list row
        const row = document.createElement('div'); row.className='panel-row';
        const tk = document.createElement('div'); tk.className='token-small'; tk.textContent = String(w.id).padStart(3,'0');
        const nm = document.createElement('div'); nm.style.flex = '1'; nm.textContent = w.name || '—';
        const st = document.createElement('div'); st.textContent = w.status;
        row.appendChild(tk); row.appendChild(nm); row.appendChild(st);
        col.appendChild(row);
      });
    }

    wrap.appendChild(col);
  });
}

fetchQueue();
const es = new EventSource(API + '/events');
['created','called','served','moved','reassigned','deleted','hold','recalled'].forEach(evt=>{
  es.addEventListener(evt, ()=>fetchQueue());
});
es.onerror = ()=> { setTimeout(fetchQueue, 1500); };
</script>
</body>
</html>
