<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Take a Token (Kiosk)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#fff;color:#111}
    .card{max-width:520px;margin:12px auto;padding:16px;border-radius:10px;border:1px solid #ddd}
    h2{margin:0 0 12px}
    #svc-list{display:block; margin-bottom:8px;}
    .svc-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;background:#f9f9f9;margin-bottom:6px;cursor:grab; user-select:none}
    .svc-row.dragging{opacity:0.3}
    .svc-row .svc-title{flex:1;font-weight:600}
    .svc-controls button{margin-left:6px}
    .btn{display:inline-block;padding:10px 12px;border-radius:6px;background:#ffd100;color:#0b4ea2;border:none;font-weight:700;width:100%}
    .hint{font-size:13px;color:#666;margin-bottom:8px}
    #result{margin-top:12px;padding:10px;border-radius:6px;background:#f1f8ff;color:#002b66;display:none}
    .disabled{opacity:0.6;pointer-events:none}
    /* ghost */
    .drag-ghost{box-shadow:0 10px 30px rgba(0,0,0,0.35);transform:scale(1.01);border-radius:6px;pointer-events:none;opacity:0.98}
    /* placeholder */
    .svc-placeholder{height:44px;border-radius:6px;background:#e9eef6;margin-bottom:6px;border:2px dashed #c7d6ee}
    /* small up/down buttons */
    .small-btn{padding:3px 6px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer}
    /* responsive */
    @media (max-width:480px){ .card{margin:8px} }
  </style>
</head>
<body>
  <div class="card">
    <h2>Take a Token</h2>
    <div class="hint">Select which services you want, then order them (first → last). You can drag rows, use the ↑/↓ buttons, or touch-and-drag on phones.</div>

    <div id="svc-list" aria-label="Service order list">
      <div class="svc-row" data-svc="registrar" tabindex="0">
        <input type="checkbox" class="svc-check" checked />
        <div class="svc-title">Registrar</div>
        <div class="svc-controls">
          <button class="small-btn up">↑</button><button class="small-btn down">↓</button>
        </div>
      </div>

      <div class="svc-row" data-svc="cashier" tabindex="0">
        <input type="checkbox" class="svc-check" checked />
        <div class="svc-title">Cashier</div>
        <div class="svc-controls"><button class="small-btn up">↑</button><button class="small-btn down">↓</button></div>
      </div>

      <div class="svc-row" data-svc="admissions" tabindex="0">
        <input type="checkbox" class="svc-check" checked />
        <div class="svc-title">Admissions</div>
        <div class="svc-controls"><button class="small-btn up">↑</button><button class="small-btn down">↓</button></div>
      </div>

      <div class="svc-row" data-svc="records" tabindex="0">
        <input type="checkbox" class="svc-check" checked />
        <div class="svc-title">Records</div>
        <div class="svc-controls"><button class="small-btn up">↑</button><button class="small-btn down">↓</button></div>
      </div>
    </div>

    <label style="display:block;margin-top:10px">Name (optional)</label>
    <input id="name" type="text" placeholder="Your name" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc">

    <label style="display:block;margin-top:10px">Type</label>
    <select id="quer" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc">
      <option>Student</option><option>Faculty/Staff</option><option>Visitor</option><option>Other</option>
    </select>

    <button id="get" class="btn" style="margin-top:12px">Get Token</button>

    <div id="result"></div>
  </div>

<script>
const API = 'http://192.168.18.34:4000'; // adjust if needed

const list = document.getElementById('svc-list');
let dragging = null;
let ghost = null;
let placeholder = null;
let offsetY = 0;

function createPlaceholder(height){
  const p = document.createElement('div');
  p.className = 'svc-placeholder';
  p.style.height = (height || 44) + 'px';
  return p;
}

function startDrag(ev, item){
  // ignore if clicking on checkboxes or buttons
  if (ev.target.closest('input') || ev.target.closest('button')) return;
  ev.preventDefault();
  dragging = item;
  const rect = item.getBoundingClientRect();
  offsetY = ev.clientY - rect.top;

  // ghost
  ghost = item.cloneNode(true);
  ghost.classList.add('drag-ghost');
  ghost.style.position = 'fixed';
  ghost.style.left = rect.left + 'px';
  ghost.style.top = rect.top + 'px';
  ghost.style.width = rect.width + 'px';
  ghost.style.zIndex = 9999;
  document.body.appendChild(ghost);

  // placeholder
  placeholder = createPlaceholder(rect.height);
  item.style.visibility = 'hidden';
  // ensure placeholder in container
  if (item.nextSibling) list.insertBefore(placeholder, item.nextSibling);
  else list.appendChild(placeholder);

  item.classList.add('dragging');

  // capture pointer for touch & mouse
  if (ev.pointerId != null) item.setPointerCapture(ev.pointerId);

  document.addEventListener('pointermove', onPointerMove);
  document.addEventListener('pointerup', endDrag);
}

function onPointerMove(e){
  if (!dragging || !ghost) return;
  // move ghost
  ghost.style.left = (e.clientX - 20) + 'px';
  ghost.style.top = (e.clientY - offsetY) + 'px';

  // Determine the element under pointer (excluding the ghost)
  const el = document.elementFromPoint(e.clientX, e.clientY);
  let row = el ? el.closest('.svc-row') : null;

  // If pointer is over a row, insert placeholder before/after it depending pointerY
  if (row && list.contains(row) && row !== dragging) {
    const rRect = row.getBoundingClientRect();
    const middle = rRect.top + rRect.height/2;
    if (e.clientY < middle) {
      if (row.previousSibling !== placeholder) list.insertBefore(placeholder, row);
    } else {
      if (row.nextSibling !== placeholder) list.insertBefore(placeholder, row.nextSibling);
    }
  } else {
    // If not over a row, ensure placeholder at end
    if (placeholder.parentNode !== list) list.appendChild(placeholder);
  }
}

function endDrag(e){
  if (!dragging) return;
  // insert dragging back into container at placeholder position
  if (placeholder && placeholder.parentNode === list) {
    list.insertBefore(dragging, placeholder);
    placeholder.remove();
  } else {
    // fallback: make it visible again
    dragging.style.visibility = '';
  }
  // cleanup
  dragging.classList.remove('dragging');
  dragging.style.visibility = '';
  if (ghost && ghost.parentNode) ghost.parentNode.removeChild(ghost);
  ghost = null;
  placeholder = null;
  dragging = null;

  document.removeEventListener('pointermove', onPointerMove);
  document.removeEventListener('pointerup', endDrag);
}

function bindRows(){
  Array.from(list.querySelectorAll('.svc-row')).forEach(row => {
    row.onpointerdown = (e) => startDrag(e, row);
    // up/down buttons
    const up = row.querySelector('.up');
    const down = row.querySelector('.down');
    if (up) up.onclick = () => { const prev = row.previousElementSibling; if (prev) list.insertBefore(row, prev); };
    if (down) down.onclick = () => { const next = row.nextElementSibling; if (next) list.insertBefore(next, row); };
  });
}

// initial bind
bindRows();

// expose a helper to get ordered selected services
function getSelectedOrderedServices() {
  return Array.from(list.querySelectorAll('.svc-row')).filter(it => it.querySelector('.svc-check').checked).map(it => it.dataset.svc);
}

// handle submission
document.getElementById('get').addEventListener('click', async () => {
  const btn = document.getElementById('get');
  const name = document.getElementById('name').value.trim();
  const quer = document.getElementById('quer').value;
  const services = getSelectedOrderedServices();
  if (!services.length) { alert('Please select at least one service'); return; }

  btn.disabled = true; btn.classList.add('disabled');
  try {
    const resp = await fetch(API + '/ticket', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, services, quer_type: quer })
    });
    if (!resp.ok) {
      let detail = resp.statusText;
      try { const j = await resp.json(); detail = j.error || j.detail || JSON.stringify(j); } catch(e){}
      alert('Failed: ' + detail);
      return;
    }
    const d = await resp.json();
    const r = document.getElementById('result');
    r.style.display = 'block';
    r.textContent = `Your token: ${String(d.id).padStart(3,'0')} — Services: ${services.join(' → ')} — Type: ${d.quer_type}`;
  } catch (e) {
    console.error('kiosk error', e);
    alert('Network error creating token');
  } finally {
    btn.disabled = false; btn.classList.remove('disabled');
  }
});

// re-bind whenever DOM changes (simple mutation observer so up/down always work after reorder)
const mo = new MutationObserver(()=> bindRows());
mo.observe(list, { childList:true, subtree:false });
</script>
</body>
</html>
